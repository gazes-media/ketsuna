"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),Object.defineProperty(exports,"default",{enumerable:!0,get:function(){return Imagine}});var _discord=require("discord.js"),_ai_horde=require("@zeldafan0225/ai_horde"),_main=require("../../../main"),_database=require("../../functions/database");function asyncGeneratorStep(e,n,t,o,a,r,i){try{var l=e[r](i),s=l.value}catch(e){t(e);return}l.done?n(s):Promise.resolve(s).then(o,a)}function _async_to_generator(e){return function(){var n=this,t=arguments;return new Promise(function(o,a){var r=e.apply(n,t);function i(e){asyncGeneratorStep(r,o,a,i,l,"next",e)}function l(e){asyncGeneratorStep(r,o,a,i,l,"throw",e)}i(void 0)})}}function _instanceof(e,n){return null!=n&&"undefined"!=typeof Symbol&&n[Symbol.hasInstance]?!!n[Symbol.hasInstance](e):e instanceof n}function _ts_generator(e,n){var t,o,a,r,i={label:0,sent:function(){if(1&a[0])throw a[1];return a[1]},trys:[],ops:[]};return r={next:l(0),throw:l(1),return:l(2)},"function"==typeof Symbol&&(r[Symbol.iterator]=function(){return this}),r;function l(r){return function(l){return function(r){if(t)throw TypeError("Generator is already executing.");for(;i;)try{if(t=1,o&&(a=2&r[0]?o.return:r[0]?o.throw||((a=o.return)&&a.call(o),0):o.next)&&!(a=a.call(o,r[1])).done)return a;switch(o=0,a&&(r=[2&r[0],a.value]),r[0]){case 0:case 1:a=r;break;case 4:return i.label++,{value:r[1],done:!1};case 5:i.label++,o=r[1],r=[0];continue;case 7:r=i.ops.pop(),i.trys.pop();continue;default:if(!(a=(a=i.trys).length>0&&a[a.length-1])&&(6===r[0]||2===r[0])){i=0;continue}if(3===r[0]&&(!a||r[1]>a[0]&&r[1]<a[3])){i.label=r[1];break}if(6===r[0]&&i.label<a[1]){i.label=a[1],a=r;break}if(a&&i.label<a[2]){i.label=a[2],i.ops.push(r);break}a[2]&&i.ops.pop(),i.trys.pop();continue}r=n.call(e,i)}catch(e){r=[6,e],o=0}finally{t=a=0}if(5&r[0])throw r[1];return{value:r[0]?r[1]:void 0,done:!0}}([r,l])}}}function Imagine(e,n){return _Imagine.apply(this,arguments)}function _Imagine(){return(_Imagine=_async_to_generator(function(e,n){var t,o,a,r,i,l,s,c,u,d,m,p,g,_,f,h,v,b,y,S,w,I,k,N,G,q,x;return _ts_generator(this,function(M){switch(M.label){case 0:return[4,(0,_database.getUser)(n.user.id,e.client.database)];case 1:if(t=M.sent(),o="0000000000",t&&t.horde_token&&(o=e.client.decryptString(t.horde_token)),!(a=e.client.timeouts.get(n.commandName)))return n.reply({content:_main.bt.__({phrase:"An error occured, please try again later",locale:n.locale}),flags:_discord.MessageFlags.Ephemeral}),[2];if(a.has(n.user.id))return n.reply({content:_main.bt.__({phrase:"You must wait the current generation before using this command again",locale:n.locale}),flags:_discord.MessageFlags.Ephemeral}),[2];return r=e.client.aiHorde,i=t.horde_config?t.horde_config:null,[4,n.reply({content:_main.bt.__({phrase:"Generation started..",locale:n.locale})})];case 2:return l=M.sent(),[4,r.getModels()];case 3:if(s=M.sent(),!_instanceof(c=n.options,_discord.CommandInteractionOptionResolver)||(u=c.getString("prompt")||"",d=c.getString("model")||(null==i?void 0:i.model)||s.sort(function(e,n){return n.count-e.count})[0].name,m=c.getString("negative_prompt")||"",p=c.getBoolean("nsfw")||(null==i?void 0:i.nsfw)||!1,g=[,,,,,].fill(null).map(function(e,n){var t;return(null==i?void 0:null===(t=i.loras[n])||void 0===t?void 0:t.loras_id)||null}),_=c.getString("loras")||g[0]||null,f=c.getString("loras_2")||g[1]||null,h=c.getString("loras_3")||g[2]||null,v=c.getString("loras_4")||g[3]||null,b=c.getString("loras_5")||g[4]||null,y=c.getBoolean("preprompt")||(null==i?void 0:i.preprompt_loras)||!1,!u))return[3,9];if(w=_instanceof(n.channel,_discord.TextChannel)?n.channel:null,I=!0,w&&(I=w.nsfw),null===(S=e.client.timeouts.get(n.commandName))||void 0===S||S.set(n.user.id,!0),k={prompt:((null==i?void 0:i.definedPrompt)||"{p}###{ng}").replace("{p}",u).replace("{ng}",m),params:{sampler_name:(null==i?void 0:i.sampler)||_ai_horde.ModelGenerationInputStableSamplers.k_euler,cfg_scale:(null==i?void 0:i.cfg_scale)||7,height:(null==i?void 0:i.height)||512,width:(null==i?void 0:i.width)||512,post_processing:[(null==i?void 0:i.upscaller)||_ai_horde.ModelGenerationInputPostProcessingTypes.RealESRGAN_x4plus],clip_skip:(null==i?void 0:i.clip_skip)||3,facefixer_strength:1,steps:(null==i?void 0:i.steps)||25,n:(null==i?void 0:i.gen_numbers)||4},censor_nsfw:!I||!p,models:[d],nsfw:!!I&&!!p,shared:!0},!((N=[_,f,h,v,b].filter(function(e){return null!==e})).length>0))return[3,8];if(!y)return[3,7];M.label=4;case 4:return M.trys.push([4,6,,7]),[4,e.client.getLorasModel(N[0])];case 5:return x=(q=(G=M.sent()).modelVersions[Math.floor(Math.random()*G.modelVersions.length)]).images[Math.floor(Math.random()*q.images.length)].meta,k.params.steps=x.steps,k.params.cfg_scale=x.cfgScale,k.prompt=x.prompt+u.substring(0,1024)+"### "+x.negativePrompt,[3,7];case 6:return M.sent(),console.log("Loras was not found"),[3,7];case 7:k.params.loras=N.map(function(e,n){return{name:e,model:n,clip:n+1,inject_trigger:"any"}}),M.label=8;case 8:var R;d.toLowerCase().includes("sdxl")?k.params.hires_fix=!1:k.params.hires_fix=!0,r.postAsyncImageGenerate(k,{token:o}).then((R=_async_to_generator(function(t){var o,a,i,s;return _ts_generator(this,function(c){switch(c.label){case 0:return o=t.id,a=0,[4,l.createMessageComponentCollector({filter:function(e){return"cancel"===e.customId&&e.user.id===n.user.id},max:1})];case 1:return i=c.sent(),s=setInterval(function(){o&&r.getImageGenerationCheck(o,{force:!0}).then(function(t){if(t.is_possible){if(t.done)clearInterval(s),i.stop("done"),null===(c=e.client.timeouts.get(n.commandName))||void 0===c||c.delete(n.user.id),r.getImageGenerationStatus(o).then(function(e){console.log({generations:e.generations.map(function(e){return{url:e.img,workerName:e.worker_name,workerId:e.worker_id,model:e.model}}),prompt:JSON.stringify(k),guildName:(null===(t=n.guild)||void 0===t?void 0:t.name)||"DM"});var t,o=e.generations;o&&o.length>0&&l.edit({content:"",files:o.map(function(e,n){return{attachment:e.img,name:"image"+n+".webp"}}),components:[]})});else{var c,u,d=[{type:1,components:[new _discord.ButtonBuilder().setCustomId("cancel").setLabel(_main.bt.__({phrase:"Cancel",locale:n.locale})).setStyle(_discord.ButtonStyle.Danger).setEmoji("\uD83D\uDEAB").setDisabled(!1).toJSON()]}],m=t.wait_time||1,p=[],g=_main.bt.__({phrase:"Generation started..",locale:n.locale})+"\n";t.queue_position&&t.queue_position>0&&(g+=_main.bt.__({phrase:"(Position in the queue: %s -",locale:n.locale},String(t.queue_position))+"\n"),t.waiting&&t.waiting>0&&(g+=_main.bt.__({phrase:"Waiting : %s",locale:n.locale},String(t.waiting))+"\n"),t.finished&&t.finished>0&&(g+=_main.bt.__({phrase:"Finished : %s",locale:n.locale},String(t.finished))+"\n"),t.processing&&t.processing>0&&(g+=_main.bt.__({phrase:"Processing : %s",locale:n.locale},String(t.processing))+"\n"+_main.bt.__({phrase:"(Estimated waiting time: <t:%s:R>)",locale:n.locale},String(parseInt(((Date.now()+1e3*m)/1e3).toString())))+"\n"),t.kudos&&t.kudos>0&&(g+=_main.bt.__({phrase:"Kudos used: %s",locale:n.locale},String(t.kudos)));var _={content:g,components:d};t.finished&&t.finished>a?(a=t.finished,r.getImageGenerationStatus(o).then(function(t){t.generations&&t.generations.length>0&&t.generations.forEach(function(e,n){p.push({attachment:e.img,name:"image"+n+".webp"})}),p.length>0&&(_.files=p),l.edit(_).catch(function(t){var a;clearInterval(s),i.stop("cancel"),null===(a=e.client.timeouts.get(n.commandName))||void 0===a||a.delete(n.user.id),e.client.aiHorde.deleteImageGenerationRequest(o)})})):l.edit(_).catch(function(t){var a;clearInterval(s),i.stop("cancel"),null===(a=e.client.timeouts.get(n.commandName))||void 0===a||a.delete(n.user.id),e.client.aiHorde.deleteImageGenerationRequest(o)})}}else clearInterval(s),null===(u=e.client.timeouts.get(n.commandName))||void 0===u||u.delete(n.user.id),n.editReply({content:_main.bt.__({phrase:"Request impossible, model not available",locale:n.locale}),components:[]}).catch(function(t){var a;clearInterval(s),i.stop("cancel"),null===(a=e.client.timeouts.get(n.commandName))||void 0===a||a.delete(n.user.id),e.client.aiHorde.deleteImageGenerationRequest(o)})})},5e3),i.on("collect",function(t){var a;i.stop("cancel"),clearInterval(s),null===(a=e.client.timeouts.get(n.commandName))||void 0===a||a.delete(n.user.id),t.update({content:_main.bt.__({phrase:"Request canceled",locale:n.locale}),components:[]}),e.client.aiHorde.deleteImageGenerationRequest(o)}),[2]}})}),function(e){return R.apply(this,arguments)})).catch(function(t){var o;"1100859965616427068"===e.client.application.id&&e.client.users.fetch("243117191774470146").then(function(e){e.send({embeds:[new _discord.EmbedBuilder().setTimestamp(new Date).setDescription((0,_discord.codeBlock)("json",JSON.stringify(t))).setTitle("Erreur lors de la g\xe9n\xe9ration d'une image").setColor(_discord.Colors.Red).addFields([{name:"Utilisateur",value:"".concat(n.user.tag," (").concat(n.user.id,")")},{name:"Commande",value:"".concat(n.commandName)},{name:"Options",value:(0,_discord.codeBlock)("json",JSON.stringify(c))}]).toJSON()]})}),null===(o=e.client.timeouts.get(n.commandName))||void 0===o||o.delete(n.user.id),n.deferred,l.edit({content:_main.bt.__({phrase:"An error occured, content too long or too complex, or request too unethical to be processed.",locale:n.locale}),components:[]})}),M.label=9;case 9:return[2]}})})).apply(this,arguments)}