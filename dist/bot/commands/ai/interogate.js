"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),Object.defineProperty(exports,"default",{enumerable:!0,get:function(){return Interogate}});var _discord=require("discord.js"),_ai_horde=require("@zeldafan0225/ai_horde"),_main=require("../../../main"),_database=require("../../functions/database");function asyncGeneratorStep(e,t,n,r,o,a,c){try{var i=e[a](c),s=i.value}catch(e){n(e);return}i.done?t(s):Promise.resolve(s).then(r,o)}function _instanceof(e,t){return null!=t&&"undefined"!=typeof Symbol&&t[Symbol.hasInstance]?!!t[Symbol.hasInstance](e):e instanceof t}function Interogate(e,t){return _Interogate.apply(this,arguments)}function _Interogate(){var e;return e=function(e,t){var n,r,o,a,c,i,s;return function(e,t){var n,r,o,a,c={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return a={next:i(0),throw:i(1),return:i(2)},"function"==typeof Symbol&&(a[Symbol.iterator]=function(){return this}),a;function i(a){return function(i){return function(a){if(n)throw TypeError("Generator is already executing.");for(;c;)try{if(n=1,r&&(o=2&a[0]?r.return:a[0]?r.throw||((o=r.return)&&o.call(r),0):r.next)&&!(o=o.call(r,a[1])).done)return o;switch(r=0,o&&(a=[2&a[0],o.value]),a[0]){case 0:case 1:o=a;break;case 4:return c.label++,{value:a[1],done:!1};case 5:c.label++,r=a[1],a=[0];continue;case 7:a=c.ops.pop(),c.trys.pop();continue;default:if(!(o=(o=c.trys).length>0&&o[o.length-1])&&(6===a[0]||2===a[0])){c=0;continue}if(3===a[0]&&(!o||a[1]>o[0]&&a[1]<o[3])){c.label=a[1];break}if(6===a[0]&&c.label<o[1]){c.label=o[1],o=a;break}if(o&&c.label<o[2]){c.label=o[2],c.ops.push(a);break}o[2]&&c.ops.pop(),c.trys.pop();continue}a=t.call(e,c)}catch(e){a=[6,e],r=0}finally{n=o=0}if(5&a[0])throw a[1];return{value:a[0]?a[1]:void 0,done:!0}}([a,i])}}}(this,function(l){switch(l.label){case 0:return[4,t.deferReply()];case 1:n=l.sent(),r=t.options,o=e.client.aiHorde,a="0000000000",l.label=2;case 2:return l.trys.push([2,4,,5]),[4,new Promise(function(n,r){(0,_database.getUser)(t.user.id,e.client.database).then(function(t){t.horde_token||r("No token found"),n(e.client.decryptString(t.horde_token))}).catch(r)})];case 3:return a=l.sent(),[3,5];case 4:return l.sent(),n.edit({content:_main.bt.__({phrase:"You must login to StableHorde",locale:t.locale})}),[3,5];case 5:return c="https://i.imgur.com/2t1lL2U.png",_instanceof(r,_discord.CommandInteractionOptionResolver)&&(c=r.getAttachment("image",!0).url),i=o.postAsyncInterrogate({source_image:c,forms:[{name:_ai_horde.ModelInterrogationFormTypes.interrogation},{name:_ai_horde.ModelInterrogationFormTypes.caption},{name:_ai_horde.ModelInterrogationFormTypes.nsfw}]},{token:a}),s=Date.now(),i.then(function(e){n.edit({content:_main.bt.__({phrase:"Request sent to the AI, please wait...",locale:t.locale})});var r=n.createMessageComponentCollector({filter:function(e){return e.user.id===t.user.id&&"cancel"===e.customId},max:1}),a=setInterval(function(){o.getInterrogationStatus(e.id).then(function(r){if(r.state&&r.state===_ai_horde.HordeAsyncRequestStates.done){var c=Date.now();clearInterval(a);var i=new _discord.EmbedBuilder;i.setTitle(_main.bt.__({phrase:"Interrogation result",locale:t.locale})),i.setDescription(r.forms.flatMap(function(e){return e.result?Object.entries(e.result).flatMap(function(e){return"## ".concat(e[0],"\n").concat(_instanceof(e[1],Object)?Object.entries(e[1]).map(function(e){return"**".concat(e[0],"**: ").concat(e[1].map(function(e){return e.text}).join(", "))}).join("\n"):e[1])}):[]}).join("\n")),i.setFooter({text:"G\xe9n\xe9r\xe9 en ".concat(Math.round((c-s)/1e3),"s")}),n.edit({content:"",embeds:[i],components:[]})}else{r.state&&r.state===_ai_horde.HordeAsyncRequestStates.faulted&&(clearInterval(a),o.deleteInterrogationRequest(e.id),n.edit({content:_main.bt.__({phrase:"An error occured",locale:t.locale})}));var l=r.state?_main.bt.__({phrase:"Request in process : %s",locale:t.locale},r.state):_main.bt.__({phrase:"Request waiting for processing",locale:t.locale});n.edit({content:l,components:[new _discord.ActionRowBuilder().addComponents(new _discord.ButtonBuilder().setCustomId("cancel").setLabel(_main.bt.__({phrase:"Cancel",locale:t.locale})).setStyle(_discord.ButtonStyle.Danger).setEmoji("\uD83D\uDEAB"))]})}}).catch(function(r){clearInterval(a),o.deleteInterrogationRequest(e.id),n.edit({content:_main.bt.__({phrase:"An error occured",locale:t.locale})})})},5e3);r.on("collect",function(n){clearInterval(a),o.deleteInterrogationRequest(e.id),n.update({content:_main.bt.__({phrase:"Request canceled",locale:t.locale}),components:[]})})}).catch(function(e){console.log(e),n.edit({content:_main.bt.__({phrase:"An error occurred, request impossible",locale:t.locale})})}),[2]}})},(_Interogate=function(){var t=this,n=arguments;return new Promise(function(r,o){var a=e.apply(t,n);function c(e){asyncGeneratorStep(a,r,o,c,i,"next",e)}function i(e){asyncGeneratorStep(a,r,o,c,i,"throw",e)}c(void 0)})}).apply(this,arguments)}