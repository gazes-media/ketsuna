"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),Object.defineProperty(exports,"default",{enumerable:!0,get:function(){return Login}});var _discord=require("discord.js"),_main=require("../../../main"),_database=require("../../functions/database");function asyncGeneratorStep(e,t,n,r,o,a,i){try{var l=e[a](i),s=l.value}catch(e){n(e);return}l.done?t(s):Promise.resolve(s).then(r,o)}function Login(e,t){return _Login.apply(this,arguments)}function _Login(){var e;return e=function(e,t){var n,r,o,a,i,l;return function(e,t){var n,r,o,a,i={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return a={next:l(0),throw:l(1),return:l(2)},"function"==typeof Symbol&&(a[Symbol.iterator]=function(){return this}),a;function l(a){return function(l){return function(a){if(n)throw TypeError("Generator is already executing.");for(;i;)try{if(n=1,r&&(o=2&a[0]?r.return:a[0]?r.throw||((o=r.return)&&o.call(r),0):r.next)&&!(o=o.call(r,a[1])).done)return o;switch(r=0,o&&(a=[2&a[0],o.value]),a[0]){case 0:case 1:o=a;break;case 4:return i.label++,{value:a[1],done:!1};case 5:i.label++,r=a[1],a=[0];continue;case 7:a=i.ops.pop(),i.trys.pop();continue;default:if(!(o=(o=i.trys).length>0&&o[o.length-1])&&(6===a[0]||2===a[0])){i=0;continue}if(3===a[0]&&(!o||a[1]>o[0]&&a[1]<o[3])){i.label=a[1];break}if(6===a[0]&&i.label<o[1]){i.label=o[1],o=a;break}if(o&&i.label<o[2]){i.label=o[2],i.ops.push(a);break}o[2]&&i.ops.pop(),i.trys.pop();continue}a=t.call(e,i)}catch(e){a=[6,e],r=0}finally{n=o=0}if(5&a[0])throw a[1];return{value:a[0]?a[1]:void 0,done:!0}}([a,l])}}}(this,function(s){switch(s.label){case 0:return[4,e.client.database.users.findFirst({where:{id:t.user.id}})];case 1:return n=s.sent(),r="",n&&n.horde_token&&(r=e.client.decryptString(n.horde_token)),t.showModal(new _discord.ModalBuilder().setTitle(_main.bt.__({phrase:"Login to StableHorde",locale:t.locale})).addComponents(new _discord.ActionRowBuilder().addComponents([new _discord.TextInputBuilder().setCustomId("token").setPlaceholder(_main.bt.__({phrase:"Token from stablehorde.net",locale:t.locale})).setMaxLength(100).setStyle(_discord.TextInputStyle.Short).setValue(r).setRequired(!0).setLabel(_main.bt.__({phrase:"Token from stablehorde.net",locale:t.locale}))])).setCustomId("login").toJSON()),[4,t.awaitModalSubmit({filter:function(e){return"login"===e.customId&&e.user.id===t.user.id},time:6e5,dispose:!0})];case 2:if(!(a=(o=s.sent()).fields.getTextInputValue("token"))||o.deferred)return[2];return[4,o.deferReply()];case 3:i=s.sent(),l=e.client.aiHorde,s.label=4;case 4:return s.trys.push([4,6,,7]),[4,l.findUser({token:a})];case 5:return s.sent(),[3,7];case 6:return s.sent(),i.edit({content:_main.bt.__({phrase:"Invalid token",locale:t.locale})}),[2];case 7:return(0,_database.createUser)({id:t.user.id,horde_token:e.client.encryptString(a)},e.client.database).then(function(){i.edit({content:_main.bt.__({phrase:"You have been logged in",locale:t.locale})})}).catch(function(e){i.edit({content:_main.bt.__({phrase:"An error occured",locale:t.locale})})}),[2,i]}})},(_Login=function(){var t=this,n=arguments;return new Promise(function(r,o){var a=e.apply(t,n);function i(e){asyncGeneratorStep(a,r,o,i,l,"next",e)}function l(e){asyncGeneratorStep(a,r,o,i,l,"throw",e)}i(void 0)})}).apply(this,arguments)}