"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),Object.defineProperty(exports,"default",{enumerable:!0,get:function(){return Give}});var _discord=require("discord.js"),_main=require("../../../main"),_database=require("../../functions/database");function asyncGeneratorStep(e,t,n,r,a,o,i){try{var s=e[o](i),c=s.value}catch(e){n(e);return}s.done?t(c):Promise.resolve(c).then(r,a)}function _async_to_generator(e){return function(){var t=this,n=arguments;return new Promise(function(r,a){var o=e.apply(t,n);function i(e){asyncGeneratorStep(o,r,a,i,s,"next",e)}function s(e){asyncGeneratorStep(o,r,a,i,s,"throw",e)}i(void 0)})}}function _ts_generator(e,t){var n,r,a,o,i={label:0,sent:function(){if(1&a[0])throw a[1];return a[1]},trys:[],ops:[]};return o={next:s(0),throw:s(1),return:s(2)},"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function s(o){return function(s){return function(o){if(n)throw TypeError("Generator is already executing.");for(;i;)try{if(n=1,r&&(a=2&o[0]?r.return:o[0]?r.throw||((a=r.return)&&a.call(r),0):r.next)&&!(a=a.call(r,o[1])).done)return a;switch(r=0,a&&(o=[2&o[0],a.value]),o[0]){case 0:case 1:a=o;break;case 4:return i.label++,{value:o[1],done:!1};case 5:i.label++,r=o[1],o=[0];continue;case 7:o=i.ops.pop(),i.trys.pop();continue;default:if(!(a=(a=i.trys).length>0&&a[a.length-1])&&(6===o[0]||2===o[0])){i=0;continue}if(3===o[0]&&(!a||o[1]>a[0]&&o[1]<a[3])){i.label=o[1];break}if(6===o[0]&&i.label<a[1]){i.label=a[1],a=o;break}if(a&&i.label<a[2]){i.label=a[2],i.ops.push(o);break}a[2]&&i.ops.pop(),i.trys.pop();continue}o=t.call(e,i)}catch(e){o=[6,e],r=0}finally{n=a=0}if(5&o[0])throw o[1];return{value:o[0]?o[1]:void 0,done:!0}}([o,s])}}}function Give(e,t){return _Give.apply(this,arguments)}function _Give(){return(_Give=_async_to_generator(function(e,t){var n,r,a,o,i,s,c,u,l,d;return _ts_generator(this,function(_){var f,h,p;switch(_.label){case 0:return[4,t.deferReply()];case 1:if(n=_.sent(),r=t.options,o=1,(null!=(f=_discord.CommandInteractionOptionResolver)&&"undefined"!=typeof Symbol&&f[Symbol.hasInstance]?!!f[Symbol.hasInstance](r):r instanceof f)&&(a=r.getUser("user"),o=r.getNumber("amount")||1),!a)return[2,n.edit({content:_main.bt.__({phrase:"You must select a user",locale:t.locale})})];if(a.id===t.user.id)return[2,n.edit({content:_main.bt.__({phrase:"You can't give kudos to yourself",locale:t.locale})})];return n.edit({content:_main.bt.__({phrase:"Searching for the user in the database",locale:t.locale})}),[4,(0,_database.getUser)(t.user.id,e.client.database)];case 2:if(!(i=_.sent()))return[2,n.edit({content:_main.bt.__({phrase:"You must login to StableHorde using %s",locale:t.locale},"</".concat(t.commandName," login:").concat(t.commandId,">"))})];if(n.edit({content:_main.bt.__({phrase:"Searching for the user in the API",locale:t.locale})}),!i.horde_token)return[2,n.edit({content:_main.bt.__({phrase:"You must login to StableHorde using %s",locale:t.locale})})];s=e.client.decryptString(i.horde_token),c=e.client.aiHorde,_.label=3;case 3:return _.trys.push([3,10,,11]),[4,c.findUser({token:s})];case 4:if(_.sent().kudos<o)return[2,n.edit({content:_main.bt.__({phrase:"You don't have enough kudos",locale:t.locale})})];return[4,(0,_database.getUser)(a.id,e.client.database)];case 5:if(!(u=_.sent()).horde_token)return[2,n.edit({content:_main.bt.__({phrase:"The user is not registered",locale:t.locale})})];_.label=6;case 6:return _.trys.push([6,8,,9]),l=e.client.decryptString(u.horde_token),[4,c.findUser({token:l})];case 7:return d=_.sent(),c.postKudosTransfer({username:d.username,amount:o},{token:s}).then((h=_async_to_generator(function(e){return _ts_generator(this,function(r){return n.edit({content:_main.bt.__({phrase:"You have given %s kudos to %s",locale:t.locale},String(e.transferred),"<@".concat(a.id,"> (").concat(d.username,")"))}),[2]})}),function(e){return h.apply(this,arguments)})).catch((p=_async_to_generator(function(e){return _ts_generator(this,function(e){return n.edit({content:_main.bt.__({phrase:"An error occured",locale:t.locale})}),[2]})}),function(e){return p.apply(this,arguments)})),[3,9];case 8:return _.sent(),[2,n.edit({content:_main.bt.__({phrase:"The user is not registered",locale:t.locale})})];case 9:return[3,11];case 10:return _.sent(),[2,n.edit({content:_main.bt.__({phrase:"Token invalid, you must login to StableHorde using %s",locale:t.locale},"</".concat(t.commandName," login:").concat(t.commandId,">"))})];case 11:return[2]}})})).apply(this,arguments)}