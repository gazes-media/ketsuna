"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),Object.defineProperty(exports,"default",{enumerable:!0,get:function(){return Ask}});var _discord=require("discord.js"),_main=require("../../../main"),_database=require("../../functions/database");function asyncGeneratorStep(e,t,n,r,o,a,i){try{var s=e[a](i),l=s.value}catch(e){n(e);return}s.done?t(l):Promise.resolve(l).then(r,o)}function Ask(e,t){return _Ask.apply(this,arguments)}function _Ask(){var e;return e=function(e,t){var n,r,o,a,i,s,l,c,u,p,d;return function(e,t){var n,r,o,a,i={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return a={next:s(0),throw:s(1),return:s(2)},"function"==typeof Symbol&&(a[Symbol.iterator]=function(){return this}),a;function s(a){return function(s){return function(a){if(n)throw TypeError("Generator is already executing.");for(;i;)try{if(n=1,r&&(o=2&a[0]?r.return:a[0]?r.throw||((o=r.return)&&o.call(r),0):r.next)&&!(o=o.call(r,a[1])).done)return o;switch(r=0,o&&(a=[2&a[0],o.value]),a[0]){case 0:case 1:o=a;break;case 4:return i.label++,{value:a[1],done:!1};case 5:i.label++,r=a[1],a=[0];continue;case 7:a=i.ops.pop(),i.trys.pop();continue;default:if(!(o=(o=i.trys).length>0&&o[o.length-1])&&(6===a[0]||2===a[0])){i=0;continue}if(3===a[0]&&(!o||a[1]>o[0]&&a[1]<o[3])){i.label=a[1];break}if(6===a[0]&&i.label<o[1]){i.label=o[1],o=a;break}if(o&&i.label<o[2]){i.label=o[2],i.ops.push(a);break}o[2]&&i.ops.pop(),i.trys.pop();continue}a=t.call(e,i)}catch(e){a=[6,e],r=0}finally{n=o=0}if(5&a[0])throw a[1];return{value:a[0]?a[1]:void 0,done:!0}}([a,s])}}}(this,function(_){switch(_.label){case 0:return[4,t.deferReply()];case 1:n=_.sent(),r=t.options,o=e.client.aiHorde,a="0000000000",_.label=2;case 2:return _.trys.push([2,4,,5]),[4,new Promise(function(n,r){(0,_database.getUser)(t.user.id,e.client.database).then(function(t){t.horde_token||r("No token found"),n(e.client.decryptString(t.horde_token))}).catch(r)})];case 3:return a=_.sent(),[3,5];case 4:return _.sent(),n.edit({content:_main.bt.__({phrase:"You must login to StableHorde",locale:t.locale})}),[3,5];case 5:var m,f;return i="",m=r,(null!=(f=_discord.CommandInteractionOptionResolver)&&"undefined"!=typeof Symbol&&f[Symbol.hasInstance]?!!f[Symbol.hasInstance](m):m instanceof f)&&(i=r.getString("question",!0),s=r.getNumber("temperature",!1),l=r.getNumber("top-p",!1),c=r.getNumber("frequency-penalty",!1)),u={prompt:i,params:{max_length:200,singleline:!0,frmttriminc:!0,frmtrmspch:!0,frmtrmblln:!0}},l&&(u.params.top_p=l),s&&(u.params.temperature=s),c&&(u.params.rep_pen=c),p=o.postAsyncTextGenerate(u,{token:a}),d=Date.now(),p.then(function(e){n.edit({content:_main.bt.__({phrase:"Request sent to the AI, please wait...",locale:t.locale})});var r=n.createMessageComponentCollector({filter:function(e){return e.user.id===t.user.id&&"cancel"===e.customId},max:1}),a=setInterval(function(){o.getTextGenerationStatus(e.id).then(function(e){if(e.done){var r=Date.now();clearInterval(a);var o=new _discord.EmbedBuilder;o.setTitle(_main.bt.__({phrase:"AI Response",locale:t.locale})),o.setDescription(e.generations[0].text),o.setFooter({text:_main.bt.__({phrase:"Time elapsed: %s seconds",locale:t.locale},String((r-d)/1e3))}),n.edit({content:"",embeds:[o],components:[]})}else{var i=e.wait_time||1,s=_main.bt.__({phrase:"Request sent to the AI, please wait...",locale:t.locale})+"\n";e.queue_position&&e.queue_position>0&&(s+=_main.bt.__({phrase:"(Position in the queue: %s -",locale:t.locale},String(e.queue_position))),e.waiting&&e.waiting>0&&(s+=" En attente: ".concat(e.waiting,")\n")+_main.bt.__({phrase:"Waiting : %s",locale:t.locale},String(e.waiting))),e.processing&&e.processing>0&&(s+=_main.bt.__({phrase:"Processing : %s",locale:t.locale},String(e.processing))+_main.bt.__({phrase:"(Estimated waiting time: <t:%s:R>)",locale:t.locale},String(parseInt(((Date.now()+1e3*i)/1e3).toString())))),e.kudos&&e.kudos>0&&(s+=_main.bt.__({phrase:"Kudos used: %s",locale:t.locale},String(e.kudos))),n.edit({content:s,components:[new _discord.ActionRowBuilder().addComponents(new _discord.ButtonBuilder().setCustomId("cancel").setLabel(_main.bt.__({phrase:"Cancel",locale:t.locale})).setStyle(_discord.ButtonStyle.Danger).setEmoji("\uD83D\uDEAB"))]})}}).catch(function(r){clearInterval(a),o.deleteTextGenerationRequest(e.id),n.edit({content:_main.bt.__({phrase:"An error occurred, request impossible",locale:t.locale})})})},5e3);r.on("collect",function(n){clearInterval(a),o.deleteTextGenerationRequest(e.id),n.update({content:_main.bt.__({phrase:"Request canceled",locale:t.locale}),components:[]})})}).catch(function(e){console.log(e),n.edit({content:_main.bt.__({phrase:"An error occurred, request impossible",locale:t.locale})})}),[2]}})},(_Ask=function(){var t=this,n=arguments;return new Promise(function(r,o){var a=e.apply(t,n);function i(e){asyncGeneratorStep(a,r,o,i,s,"next",e)}function s(e){asyncGeneratorStep(a,r,o,i,s,"throw",e)}i(void 0)})}).apply(this,arguments)}