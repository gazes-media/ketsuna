"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),Object.defineProperty(exports,"default",{enumerable:!0,get:function(){return AdvancedImagine}});var _discord=require("discord.js"),_ai_horde=require("@zeldafan0225/ai_horde"),_main=require("../../../../main"),_database=require("../../../functions/database");function asyncGeneratorStep(e,t,n,a,o,r,i){try{var s=e[r](i),l=s.value}catch(e){n(e);return}s.done?t(l):Promise.resolve(l).then(a,o)}function _async_to_generator(e){return function(){var t=this,n=arguments;return new Promise(function(a,o){var r=e.apply(t,n);function i(e){asyncGeneratorStep(r,a,o,i,s,"next",e)}function s(e){asyncGeneratorStep(r,a,o,i,s,"throw",e)}i(void 0)})}}function _instanceof(e,t){return null!=t&&"undefined"!=typeof Symbol&&t[Symbol.hasInstance]?!!t[Symbol.hasInstance](e):e instanceof t}function _ts_generator(e,t){var n,a,o,r,i={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return r={next:s(0),throw:s(1),return:s(2)},"function"==typeof Symbol&&(r[Symbol.iterator]=function(){return this}),r;function s(r){return function(s){return function(r){if(n)throw TypeError("Generator is already executing.");for(;i;)try{if(n=1,a&&(o=2&r[0]?a.return:r[0]?a.throw||((o=a.return)&&o.call(a),0):a.next)&&!(o=o.call(a,r[1])).done)return o;switch(a=0,o&&(r=[2&r[0],o.value]),r[0]){case 0:case 1:o=r;break;case 4:return i.label++,{value:r[1],done:!1};case 5:i.label++,a=r[1],r=[0];continue;case 7:r=i.ops.pop(),i.trys.pop();continue;default:if(!(o=(o=i.trys).length>0&&o[o.length-1])&&(6===r[0]||2===r[0])){i=0;continue}if(3===r[0]&&(!o||r[1]>o[0]&&r[1]<o[3])){i.label=r[1];break}if(6===r[0]&&i.label<o[1]){i.label=o[1],o=r;break}if(o&&i.label<o[2]){i.label=o[2],i.ops.push(r);break}o[2]&&i.ops.pop(),i.trys.pop();continue}r=t.call(e,i)}catch(e){r=[6,e],a=0}finally{n=o=0}if(5&r[0])throw r[1];return{value:r[0]?r[1]:void 0,done:!0}}([r,s])}}}function AdvancedImagine(e,t){return _AdvancedImagine.apply(this,arguments)}function _AdvancedImagine(){return(_AdvancedImagine=_async_to_generator(function(e,t){var n,a,o,r,i,s,l,c,u,d,m,p,g,_,f,h,b,v,y,w,S,I;return _ts_generator(this,function(N){switch(N.label){case 0:return[4,(0,_database.getUser)(t.user.id,e.client.database)];case 1:if(n=N.sent(),a="0000000000",n&&n.horde_token&&(a=e.client.decryptString(n.horde_token)),!(o=e.client.timeouts.get(t.commandName)))return t.reply({content:_main.bt.__({phrase:"An error occured, please try again later",locale:t.locale}),flags:_discord.MessageFlags.Ephemeral}),[2];if(o.has(t.user.id))return t.reply({content:_main.bt.__({phrase:"You must wait the current generation before using this command again",locale:t.locale}),flags:_discord.MessageFlags.Ephemeral}),[2];return r=e.client.aiHorde,[4,t.deferReply()];case 2:return i=N.sent(),[4,r.getModels()];case 3:if(s=N.sent(),_instanceof(l=t.options,_discord.CommandInteractionOptionResolver)&&(c=l.getString("prompt")||"",u=l.getString("model")||s.sort(function(e,t){return t.count-e.count})[0].name,d=l.getString("negative_prompt")||"",m=l.getBoolean("nsfw")||!1,p=l.getNumber("step")||25,g=l.getNumber("clip_skip")||3,_=l.getNumber("height")||512,f=l.getNumber("width")||512,h=l.getString("sampler_name")||_ai_horde.ModelGenerationInputStableSamplers.k_dpm_adaptive,b=(l.getNumber("n")||4)>10?10:l.getNumber("n")||4,v=l.getString("loras")||null,c)){var k;w=_instanceof(t.channel,_discord.TextChannel)?t.channel:null,S=!0,w&&(S=w.nsfw),null===(y=e.client.timeouts.get(t.commandName))||void 0===y||y.set(t.user.id,!0),I={prompt:c+"### "+d,params:{sampler_name:h,cfg_scale:7,denoising_strength:.75,height:_,width:f,post_processing:[_ai_horde.ModelGenerationInputPostProcessingTypes.RealESRGAN_x4plus],karras:!0,tiling:!1,hires_fix:!0,clip_skip:g,facefixer_strength:.75,steps:p,n:b},censor_nsfw:!S||!m,models:[u],nsfw:!!S&&!!m,shared:!0},u.toLowerCase().includes("sdxl")&&(I.params.hires_fix=!1),v&&(I.params.loras=[{name:v,model:1,clip:1,inject_trigger:"any"}]),r.postAsyncImageGenerate(I,{token:a}).then((k=_async_to_generator(function(n){var a,o,s,l;return _ts_generator(this,function(c){switch(c.label){case 0:return a=n.id,o=0,[4,i.createMessageComponentCollector({filter:function(e){return"cancel"===e.customId&&e.user.id===t.user.id},max:1})];case 1:return s=c.sent(),l=setInterval(function(){a&&r.getImageGenerationCheck(a,{force:!0}).then(function(n){if(n.is_possible){if(n.done)clearInterval(l),s.stop("done"),null===(i=e.client.timeouts.get(t.commandName))||void 0===i||i.delete(t.user.id),r.getImageGenerationStatus(a).then(function(e){console.log({generations:e.generations.map(function(e){return{url:e.img,workerName:e.worker_name,workerId:e.worker_id,model:e.model}}),prompt:JSON.stringify(I),guildName:(null===(n=t.guild)||void 0===n?void 0:n.name)||"DM"});var n,a=e.generations;a&&a.length>0&&t.editReply({content:"",files:a.map(function(e,t){return{attachment:e.img,name:"image"+t+".webp"}}),components:[]})});else{var i,c,u=[{type:1,components:[new _discord.ButtonBuilder().setCustomId("cancel").setLabel(_main.bt.__({phrase:"Cancel",locale:t.locale})).setEmoji("\uD83D\uDEAB").setStyle(_discord.ButtonStyle.Danger).setDisabled(!1).toJSON()]}],d=n.wait_time||1,m=[],p=_main.bt.__({phrase:"Generation started..",locale:t.locale})+"\n";n.queue_position&&n.queue_position>0&&(p+=_main.bt.__({phrase:"(Position in the queue: %s -",locale:t.locale},String(n.queue_position))+"\n"),n.waiting&&n.waiting>0&&(p+=_main.bt.__({phrase:"Waiting : %s",locale:t.locale},String(n.waiting))+"\n"),n.finished&&n.finished>0&&(p+=_main.bt.__({phrase:"Finished : %s",locale:t.locale},String(n.finished))+"\n"),n.processing&&n.processing>0&&(p+=_main.bt.__({phrase:"Processing : %s",locale:t.locale},String(n.processing))+"\n"+_main.bt.__({phrase:"(Estimated waiting time: <t:%s:R>)",locale:t.locale},String(parseInt(((Date.now()+1e3*d)/1e3).toString())))+"\n"),n.kudos&&n.kudos>0&&(p+=_main.bt.__({phrase:"Kudos used: %s",locale:t.locale},String(n.kudos)));var g={content:p,components:u};n.finished&&n.finished>o?(o=n.finished,r.getImageGenerationStatus(a).then(function(n){n.generations&&n.generations.length>0&&n.generations.forEach(function(e,t){m.push({attachment:e.img,name:"image"+t+".webp"})}),m.length>0&&(g.files=m),t.editReply(g).catch(function(n){var o;clearInterval(l),s.stop("cancel"),null===(o=e.client.timeouts.get(t.commandName))||void 0===o||o.delete(t.user.id),e.client.aiHorde.deleteImageGenerationRequest(a)})})):t.editReply(g).catch(function(n){var o;clearInterval(l),s.stop("cancel"),null===(o=e.client.timeouts.get(t.commandName))||void 0===o||o.delete(t.user.id),e.client.aiHorde.deleteImageGenerationRequest(a)})}}else clearInterval(l),null===(c=e.client.timeouts.get(t.commandName))||void 0===c||c.delete(t.user.id),t.editReply({content:_main.bt.__({phrase:"Request impossible, model not available",locale:t.locale}),components:[]}).catch(function(n){var o;clearInterval(l),s.stop("cancel"),null===(o=e.client.timeouts.get(t.commandName))||void 0===o||o.delete(t.user.id),e.client.aiHorde.deleteImageGenerationRequest(a)})})},5e3),s.on("collect",function(n){var o;s.stop("cancel"),clearInterval(l),null===(o=e.client.timeouts.get(t.commandName))||void 0===o||o.delete(t.user.id),n.update({content:_main.bt.__({phrase:"Request canceled",locale:t.locale}),components:[]}),e.client.aiHorde.deleteImageGenerationRequest(a)}),[2]}})}),function(e){return k.apply(this,arguments)})).catch(function(n){var a;"1100859965616427068"===e.client.application.id&&e.client.users.fetch("243117191774470146").then(function(e){e.send({embeds:[new _discord.EmbedBuilder().setTimestamp(new Date).setDescription((0,_discord.codeBlock)("json",JSON.stringify(n))).setTitle("Erreur lors de la g\xe9n\xe9ration d'une image").setColor(_discord.Colors.Red).addFields([{name:"Utilisateur",value:"".concat(t.user.tag," (").concat(t.user.id,")")},{name:"Commande",value:"".concat(t.commandName)},{name:"Options",value:(0,_discord.codeBlock)("json",JSON.stringify(l))}]).toJSON()]})}),null===(a=e.client.timeouts.get(t.commandName))||void 0===a||a.delete(t.user.id),t.deferred,t.editReply({content:_main.bt.__({phrase:"An error occured, content too long or too complex, or request too unethical to be processed.",locale:t.locale}),components:[]})})}return[2]}})})).apply(this,arguments)}